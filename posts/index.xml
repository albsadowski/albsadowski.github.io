<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Posts on albert's blog</title><link>https://albsadowski.github.io/posts/</link><description>Recent content in Posts on albert's blog</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Sat, 01 Mar 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://albsadowski.github.io/posts/index.xml" rel="self" type="application/rss+xml"/><item><title>TIL: Preserving Form State with React's useActionState Hook</title><link>https://albsadowski.github.io/til-preserving-form-state-with-reacts-useactionstate-hook/</link><pubDate>Sat, 01 Mar 2025 00:00:00 +0000</pubDate><guid>https://albsadowski.github.io/til-preserving-form-state-with-reacts-useactionstate-hook/</guid><description>&lt;p>React recently introduced the &lt;a href="https://react.dev/reference/react/useActionState">&lt;code>useActionState&lt;/code>&lt;/a> hook, and while the official docs provide basic examples, I immediately wanted to tackle a common real-world scenario: preserving form input values after submission errors.&lt;/p>
&lt;h2 id="the-problem">The Problem&lt;/h2>
&lt;p>When a user submits a form with invalid credentials, we typically want to:&lt;/p>
&lt;ol>
&lt;li>Show an error message&lt;/li>
&lt;li>Preserve what they&amp;rsquo;ve already typed (especially for multi-field forms)&lt;/li>
&lt;/ol>
&lt;p>Without this, users face the frustration of re-typing information they&amp;rsquo;ve already entered.&lt;/p>
&lt;h2 id="traditional-approach">Traditional Approach&lt;/h2>
&lt;p>The traditional approach requires maintaining controlled components with &lt;code>onChange&lt;/code> handlers:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-jsx" data-lang="jsx">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">SignInForm&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> [&lt;span style="color:#a6e22e">email&lt;/span>, &lt;span style="color:#a6e22e">setEmail&lt;/span>] &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">useState&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> [&lt;span style="color:#a6e22e">password&lt;/span>, &lt;span style="color:#a6e22e">setPassword&lt;/span>] &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">useState&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;&amp;#39;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> [&lt;span style="color:#a6e22e">error&lt;/span>, &lt;span style="color:#a6e22e">setError&lt;/span>] &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">useState&lt;/span>(&lt;span style="color:#66d9ef">null&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">handleSubmit&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">async&lt;/span> (&lt;span style="color:#a6e22e">e&lt;/span>) =&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">e&lt;/span>.&lt;span style="color:#a6e22e">preventDefault&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">try&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">signIn&lt;/span>(&lt;span style="color:#a6e22e">email&lt;/span>, &lt;span style="color:#a6e22e">password&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">catch&lt;/span> (&lt;span style="color:#a6e22e">err&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">setError&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;Invalid credentials&amp;#39;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> (
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;&lt;span style="color:#f92672">form&lt;/span> &lt;span style="color:#a6e22e">onSubmit&lt;/span>&lt;span style="color:#f92672">=&lt;/span>{&lt;span style="color:#a6e22e">handleSubmit&lt;/span>}&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {&lt;span style="color:#a6e22e">error&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &amp;lt;&lt;span style="color:#f92672">div&lt;/span> &lt;span style="color:#a6e22e">className&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;error&amp;#34;&lt;/span>&amp;gt;{&lt;span style="color:#a6e22e">error&lt;/span>}&amp;lt;/&lt;span style="color:#f92672">div&lt;/span>&amp;gt;}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;&lt;span style="color:#f92672">input&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">type&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;email&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">value&lt;/span>&lt;span style="color:#f92672">=&lt;/span>{&lt;span style="color:#a6e22e">email&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">onChange&lt;/span>&lt;span style="color:#f92672">=&lt;/span>{(&lt;span style="color:#a6e22e">e&lt;/span>) =&amp;gt; &lt;span style="color:#a6e22e">setEmail&lt;/span>(&lt;span style="color:#a6e22e">e&lt;/span>.&lt;span style="color:#a6e22e">target&lt;/span>.&lt;span style="color:#a6e22e">value&lt;/span>)}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> /&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;&lt;span style="color:#f92672">input&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">type&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;password&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">value&lt;/span>&lt;span style="color:#f92672">=&lt;/span>{&lt;span style="color:#a6e22e">password&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">onChange&lt;/span>&lt;span style="color:#f92672">=&lt;/span>{(&lt;span style="color:#a6e22e">e&lt;/span>) =&amp;gt; &lt;span style="color:#a6e22e">setPassword&lt;/span>(&lt;span style="color:#a6e22e">e&lt;/span>.&lt;span style="color:#a6e22e">target&lt;/span>.&lt;span style="color:#a6e22e">value&lt;/span>)}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> /&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;&lt;span style="color:#f92672">button&lt;/span> &lt;span style="color:#a6e22e">type&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;submit&amp;#34;&lt;/span>&amp;gt;&lt;span style="color:#a6e22e">Sign&lt;/span> &lt;span style="color:#a6e22e">In&lt;/span>&amp;lt;/&lt;span style="color:#f92672">button&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;/&lt;span style="color:#f92672">form&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="the-useactionstate-approach">The &lt;code>useActionState&lt;/code> Approach&lt;/h2>
&lt;p>With &lt;code>useActionState&lt;/code>, we can achieve the same result with less code and without tracking intermediate states:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-js" data-lang="js">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&amp;#39;use server&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">async&lt;/span> &lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">signInAction&lt;/span>(&lt;span style="color:#a6e22e">prevState&lt;/span>, &lt;span style="color:#a6e22e">formData&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">email&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">formData&lt;/span>.&lt;span style="color:#a6e22e">get&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;email&amp;#39;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">password&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">formData&lt;/span>.&lt;span style="color:#a6e22e">get&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;password&amp;#39;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">try&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">signIn&lt;/span>(&lt;span style="color:#a6e22e">email&lt;/span>, &lt;span style="color:#a6e22e">password&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> { &lt;span style="color:#a6e22e">success&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">catch&lt;/span> (&lt;span style="color:#a6e22e">error&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">email&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">error&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#39;Invalid credentials&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-jsx" data-lang="jsx">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">import&lt;/span> { &lt;span style="color:#a6e22e">useActionState&lt;/span> } &lt;span style="color:#a6e22e">from&lt;/span> &lt;span style="color:#e6db74">&amp;#39;react&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">SignInForm&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> [&lt;span style="color:#a6e22e">state&lt;/span>, &lt;span style="color:#a6e22e">formAction&lt;/span>] &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">useActionState&lt;/span>(&lt;span style="color:#a6e22e">signInAction&lt;/span>, {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// initial state
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> })
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#a6e22e">state&lt;/span>&lt;span style="color:#f92672">?&lt;/span>.&lt;span style="color:#a6e22e">success&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &amp;lt;&lt;span style="color:#f92672">div&lt;/span>&amp;gt;&lt;span style="color:#a6e22e">You&lt;/span>&lt;span style="color:#e6db74">&amp;#39;re signed in!&amp;lt;/div&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> }
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> return (
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> &amp;lt;form action={formAction}&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> {state?.error &amp;amp;&amp;amp; &amp;lt;div className=&amp;#34;error&amp;#34;&amp;gt;{state.error}&amp;lt;/div&amp;gt;}
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> &amp;lt;input
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> type=&amp;#34;email&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> name=&amp;#34;email&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> defaultValue={state?.email || &amp;#39;&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&amp;#39;&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">required&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;&lt;span style="color:#f92672">input&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">type&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;password&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">name&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;password&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">required&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> /&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;&lt;span style="color:#f92672">button&lt;/span> &lt;span style="color:#a6e22e">type&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;submit&amp;#34;&lt;/span>&amp;gt;&lt;span style="color:#a6e22e">Sign&lt;/span> &lt;span style="color:#a6e22e">In&lt;/span>&amp;lt;/&lt;span style="color:#f92672">button&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;/&lt;span style="color:#f92672">form&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The key part is to set the &lt;em>defaultValue&lt;/em> on the &lt;em>input&lt;/em>.&lt;/p>
&lt;p>In particular, I&amp;rsquo;m a fan on letting the native components do its job. Historically, React (or people using React) used to track every piece of state - think of the state of &lt;em>input&lt;/em>, kept in &lt;em>state&lt;/em> and tracked with &lt;em>onChange&lt;/em>. I&amp;rsquo;m happy with the paradigm shift.&lt;/p></description></item><item><title>Typed Configuration Object in TypeScript</title><link>https://albsadowski.github.io/typed-configuration-object-in-typescript/</link><pubDate>Sun, 16 Jul 2023 00:00:00 +0000</pubDate><guid>https://albsadowski.github.io/typed-configuration-object-in-typescript/</guid><description>&lt;h2 id="compile-time-vs-runtime-in-typescript">Compile-Time vs Runtime in TypeScript&lt;/h2>
&lt;p>&lt;em>TypeScript&lt;/em> is an amazing technology, but it has been build under the assumption is compiles down to &lt;em>JavaScript&lt;/em>. As a consequence, all the wonderful types one can enjoy during the compile time, are completely gone during the runtime. Thus, it&amp;rsquo;s crucial to validate all the data from the IO.&lt;/p>
&lt;p>As the types doesn&amp;rsquo;t leave us any information about the data at the runtime, we usually end up maintaining two definitions of the same: (1) the class/interface for the typing purposes (2) JSON schema for validation purposes.&lt;/p>
&lt;p>There are many libraries/attempts to help with the problem, but my favourite is &lt;a href="https://ajv.js.org/">Ajv&lt;/a>. Ajv can work as a standard JSON schema validation tool, but it has a superpower of making the &lt;a href="https://ajv.js.org/json-schema.html">JSON Schema&lt;/a>/&lt;a href="https://ajv.js.org/json-type-definition.html">JSON Type Definition&lt;/a> visible to TypeScript, i.e., from the JSON Schema/Type Def defined in the codebase, Ajv can transform that object into a TypeScript &lt;code>type&lt;/code> at the compile-time, e.g.:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ts" data-lang="ts">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">import&lt;/span> { &lt;span style="color:#a6e22e">JTDDataType&lt;/span> } &lt;span style="color:#66d9ef">from&lt;/span> &lt;span style="color:#e6db74">&amp;#34;ajv/dist/jtd&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">FooSchema&lt;/span> &lt;span style="color:#f92672">=&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">properties&lt;/span>&lt;span style="color:#f92672">:&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">foo&lt;/span>&lt;span style="color:#f92672">:&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">type&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#34;string&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>} &lt;span style="color:#66d9ef">as&lt;/span> &lt;span style="color:#66d9ef">const&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">Foo&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">JTDDataType&lt;/span>&amp;lt;&lt;span style="color:#f92672">typeof&lt;/span> &lt;span style="color:#a6e22e">FooSchema&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The &lt;code>FooSchema&lt;/code> definition can be used for the actual validation, and the &lt;code>Foo&lt;/code> is a type definition we can use in our codebase, thus we don&amp;rsquo;t need an additional &lt;code>interface&lt;/code>/&lt;code>class&lt;/code> re-definition.&lt;/p>
&lt;h2 id="using-ajv-for-configuration-object">Using Ajv for Configuration Object&lt;/h2>
&lt;p>When writing a nodejs application, one of the first dynamically typed pieces of information to deal with is configuration. We either load from a file, environment or maybe a secrets manager, but it&amp;rsquo;s all guaranteed to be untyped by default.&lt;/p>
&lt;p>With Ajv, one can define a configuration schema, leverage that for validation purposes and use the magic of type transformation to get the typings for the schema.&lt;/p>
&lt;p>As there&amp;rsquo;s some boilerplate around reading files/environment, I ended up extracing that into a small, Ajv-based, library &lt;a href="https://github.com/albsadowski/config">@dumpstate/config&lt;/a>.&lt;/p>
&lt;p>From now on, when I deal with configuration in nodejs, my code looks as follows:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ts" data-lang="ts">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">import&lt;/span> { &lt;span style="color:#a6e22e">ConfigSchemaType&lt;/span>, &lt;span style="color:#a6e22e">loadConfig&lt;/span> } &lt;span style="color:#66d9ef">from&lt;/span> &lt;span style="color:#e6db74">&amp;#34;@dumpstate/config&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// NB I prefer JSON Type Definition
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">ConfigSchema&lt;/span> &lt;span style="color:#f92672">=&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">properties&lt;/span>&lt;span style="color:#f92672">:&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">app&lt;/span>&lt;span style="color:#f92672">:&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">properties&lt;/span>&lt;span style="color:#f92672">:&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">host&lt;/span>&lt;span style="color:#f92672">:&lt;/span> { &lt;span style="color:#66d9ef">type&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#34;string&amp;#34;&lt;/span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">port&lt;/span>&lt;span style="color:#f92672">:&lt;/span> { &lt;span style="color:#66d9ef">type&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#34;int32&amp;#34;&lt;/span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>} &lt;span style="color:#66d9ef">as&lt;/span> &lt;span style="color:#66d9ef">const&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// NB ConfigSchemaType is just convenience proxy to JTDDataType from Ajv
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">Config&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">ConfigSchemaType&lt;/span>&amp;lt;&lt;span style="color:#f92672">typeof&lt;/span> &lt;span style="color:#a6e22e">ConfigSchema&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// NB config is of `Config` type - both typed and validated
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">config&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">loadConfig&lt;/span>(&lt;span style="color:#a6e22e">ConfigSchema&lt;/span>, { &lt;span style="color:#a6e22e">appName&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#34;foo&amp;#34;&lt;/span> })
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>loadConfig&lt;/code> supports two configuration loaders (in the order of loading):&lt;/p>
&lt;ol>
&lt;li>file configuration loader:&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>loads &lt;code>config/default.application.json&lt;/code>,&lt;/li>
&lt;li>loads &lt;code>config/application.json&lt;/code>,&lt;/li>
&lt;li>loads any file provided as &lt;code>APPLICATION_CONFIG&lt;/code> environment variable.&lt;/li>
&lt;/ul>
&lt;ol start="2">
&lt;li>environment configuration loader:&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>expects environment variables in the format e.g., &lt;code>${appName}__APP__HOST&lt;/code>, where the &lt;code>appName&lt;/code> is the name of the application passed to the &lt;code>loadConfig&lt;/code>, then all &lt;code>.&lt;/code> on the JSON path are transformed into &lt;code>__&lt;/code> and camel cased properties are snake cased.&lt;/li>
&lt;/ul>
&lt;h2 id="links">Links&lt;/h2>
&lt;ol>
&lt;li>&lt;a href="https://ajv.js.org/">Ajv&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/albsadowski/config">@dumpstate/config&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>Reader Monad for DB Connection in TypeScript</title><link>https://albsadowski.github.io/reader-monad-for-db-connection-in-typescript/</link><pubDate>Mon, 29 May 2023 00:00:00 +0000</pubDate><guid>https://albsadowski.github.io/reader-monad-for-db-connection-in-typescript/</guid><description>&lt;h2 id="mvcs">MVC(S)&lt;/h2>
&lt;p>The &lt;em>Model-View-Controller&lt;/em> is usually a standard pattern for building web applications. Whether the &lt;em>view&lt;/em> is expressed as HTML or perhaps just plain JSON, it helps to structure the application in an elegant way.&lt;/p>
&lt;p>The &lt;em>Model&lt;/em> is a set of components responsible for representing the persistence layer, often in the form of some ORM classes. &lt;em>View&lt;/em> maintains the recipe for generating the &lt;em>view&lt;/em> given the &lt;em>model&lt;/em>. Finally &lt;em>controller&lt;/em> glues both parts together and deals with the other problems inherent in web development, such as parsing and interpreting query parameters.&lt;/p>
&lt;p>Where does the business logic live? As long as the application is trivial, the &lt;em>model&lt;/em> representation, combined with the power of ORMs, provides a powerful tool for manifesting the business domain. Then, the actual logic, either leaks to the &lt;em>controller&lt;/em> or requires another component in the MVC pattern.&lt;/p>
&lt;p>The &lt;em>service&lt;/em> could be one of these components. The &lt;em>service&lt;/em> sits between the &lt;em>controller&lt;/em> and the &lt;em>model&lt;/em>, either by contructing higher level &lt;em>model&lt;/em> objects (non-ORM), or by simply enriching the ORM objects with an additional computation.&lt;/p>
&lt;h2 id="acid">ACID&lt;/h2>
&lt;p>As the application grows, the &lt;em>services&lt;/em> become complex, often forming a hierarchy. Assuming there&amp;rsquo;s still a database-backed &lt;em>model&lt;/em> under the hood, all the &lt;em>services&lt;/em> do is run a sequence of database queries to either read or mutate the state of the system.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ts" data-lang="ts">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">async&lt;/span> &lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">controllerMethod() {&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">res1&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>.&lt;span style="color:#a6e22e">service1&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>.&lt;span style="color:#a6e22e">service2&lt;/span>(&lt;span style="color:#a6e22e">res1&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>How can we ensure that a &lt;em>controller&lt;/em> calling one or more &lt;em>services&lt;/em>, maintains the &lt;em>transation&lt;/em> boundary? We need to make all the components aware of the current state of the transaction. The current transaction state is usually just an instance of a &lt;em>database connection&lt;/em>. And that&amp;rsquo;s the moment where an implementation &lt;em>detail&lt;/em> of the &lt;em>model&lt;/em> brutally leaks through the MVC(S) stack.&lt;/p>
&lt;p>If you want to make a &lt;em>service&lt;/em> transactional, it should accept a &lt;em>database connection&lt;/em> as a parameter on every method of a &lt;em>service&lt;/em>. This is inconvenient and tightly couples all of the web application code to a chosen database (+ probably a chosen ORM/similar).&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ts" data-lang="ts">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">async&lt;/span> &lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">controllerMethod() {&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">tr&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">dbPool&lt;/span>.&lt;span style="color:#a6e22e">transact&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">try&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">res1&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>.&lt;span style="color:#a6e22e">service1&lt;/span>(&lt;span style="color:#a6e22e">tr&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">res2&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>.&lt;span style="color:#a6e22e">service2&lt;/span>(&lt;span style="color:#a6e22e">tr&lt;/span>, &lt;span style="color:#a6e22e">res1&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">tr&lt;/span>.&lt;span style="color:#a6e22e">commit&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">res2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">catch&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">tr&lt;/span>.&lt;span style="color:#a6e22e">rollback&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Another way to solve this problem via the state of the &lt;em>request&lt;/em> - but the problem is equivalent - now we either inject the &lt;em>request&lt;/em> or couple application code with a chosen web framework.&lt;/p>
&lt;p>The approach suggested in this blog post is the &lt;em>monad way&lt;/em>.&lt;/p>
&lt;h2 id="the-monad-way">The Monad Way&lt;/h2>
&lt;p>The &lt;a href="https://hackage.haskell.org/package/mtl-2.3.1/docs/Control-Monad-Reader.html">&lt;em>Reader monad&lt;/em>&lt;/a> is a well known pattern in the &lt;em>Haskell&lt;/em> community to solve the problem of a shared &lt;em>environment&lt;/em> between several components of the system.&lt;/p>
&lt;p>The idea is quite simple:&lt;/p>
&lt;ol>
&lt;li>do not require the &lt;em>environment&lt;/em> until you actually need it,&lt;/li>
&lt;li>use &lt;em>monad&lt;/em> properties to compose functions that depends on the &lt;em>environment&lt;/em>.&lt;/li>
&lt;/ol>
&lt;p>In our case, the &lt;em>environment&lt;/em> is a database connection - either raw connection, or a transaction.&lt;/p>
&lt;p>Point (1) above, is easier said than done, but in practice we can describe the whole computation process as a chain of lazily evaluated functions. Then, the final artefact should be a function that actually executes the program given the &lt;em>environment&lt;/em> (database connection).&lt;/p>
&lt;p>For &lt;em>TypeScript&lt;/em> I have extracted the boilerplate into &lt;a href="https://github.com/albsadowski/dbaction">&lt;em>DBAction&lt;/em>&lt;/a> library, an example:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ts" data-lang="ts">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">async&lt;/span> &lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">controllerMethod() {&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>.&lt;span style="color:#a6e22e">service1&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .&lt;span style="color:#a6e22e">flatMap&lt;/span>(&lt;span style="color:#a6e22e">res&lt;/span> &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#66d9ef">this&lt;/span>.&lt;span style="color:#a6e22e">service2&lt;/span>(&lt;span style="color:#a6e22e">res&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .&lt;span style="color:#a6e22e">transact&lt;/span>(&lt;span style="color:#66d9ef">this&lt;/span>.&lt;span style="color:#a6e22e">transactor&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Let&amp;rsquo;s break this down:&lt;/p>
&lt;h3 id="dbaction">DBAction&lt;/h3>
&lt;p>&lt;em>DBAction&lt;/em> is an actual &lt;em>reader monad&lt;/em> for the database connection. What services return is not a &lt;code>Promise&amp;lt;Result&amp;gt;&lt;/code> type (a &lt;em>promise&lt;/em> of some kind of result), but &lt;code>DBAction&amp;lt;Result&amp;gt;&lt;/code>. After the service is called &lt;code>this.service1()&lt;/code>, nothing happens until we either &lt;code>run&lt;/code> or &lt;code>transact&lt;/code> the &lt;code>DBAction&lt;/code>. The value is referentially transparent, so if you call &lt;code>this.service1&lt;/code> with the same input, you&amp;rsquo;ll always get the same result.&lt;/p>
&lt;p>The cost of this approach, is that all the components involved in the chain, must return &lt;em>DBActions&lt;/em>. On the implementation side, this means that the moment you actually need the database connection, you should wrap it in a function that takes &lt;em>database connection&lt;/em> as its only argument and returns a &lt;em>promise&lt;/em> of some result type, e.g.:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ts" data-lang="ts">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">service1&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">DBAction&lt;/span>((&lt;span style="color:#a6e22e">conn&lt;/span>) &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#a6e22e">conn&lt;/span>.&lt;span style="color:#a6e22e">query&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;select...&amp;#34;&lt;/span>))
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>There are two methods available on the &lt;em>DBAction&lt;/em> that should help composing the monad:&lt;/p>
&lt;ol>
&lt;li>&lt;code>.map&amp;lt;K&amp;gt;(fn: (item: T) =&amp;gt; K)&lt;/code> - mapping inner value into another value,&lt;/li>
&lt;li>&lt;code>.flatMap&amp;lt;K&amp;gt;(fn: (item: T) =&amp;gt; DBAction&amp;lt;K&amp;gt;)&lt;/code> - mapping inner value into another value, where the &lt;code>fn&lt;/code> function also require the &lt;em>database connection&lt;/em> for the computation.&lt;/li>
&lt;/ol>
&lt;p>The &lt;em>DBAction&lt;/em> can be:&lt;/p>
&lt;ol>
&lt;li>&lt;code>.run(tr: Transactor): Promise&amp;lt;T&amp;gt;&lt;/code> - meaning the transactor will inject plain database connection into the chain,&lt;/li>
&lt;li>&lt;code>.transact(tr: Transactor): Promise&amp;lt;T&amp;gt;&lt;/code> - the transactor will start the transaction and then inject the connection into the chain, finally &lt;em>commit&lt;/em> or &lt;em>rollback&lt;/em>.&lt;/li>
&lt;/ol>
&lt;h3 id="transactor">Transactor&lt;/h3>
&lt;p>The &lt;em>transactor&lt;/em> is a component that knows:&lt;/p>
&lt;ol>
&lt;li>the type of the database connection,&lt;/li>
&lt;li>the details of establishing the database connection, or requesting the connection from the pool,&lt;/li>
&lt;li>the details of executing the query and/or managing the transaction context.&lt;/li>
&lt;/ol>
&lt;p>The &lt;em>transactor&lt;/em> is database specific and depends on the database driver. There should be a single transactor for the entire application.&lt;/p>
&lt;p>As of now, &lt;em>DBAction&lt;/em> offers the one for &lt;em>PostgreSQL&lt;/em>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ts" data-lang="ts">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">import&lt;/span> { &lt;span style="color:#a6e22e">Transactor&lt;/span> } &lt;span style="color:#66d9ef">from&lt;/span> &lt;span style="color:#e6db74">&amp;#34;@dumpstate/dbaction/lib/PG&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// `pool` - an instance of `pg` connection pool
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">tr&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">Transactor&lt;/span>(&lt;span style="color:#a6e22e">pool&lt;/span>)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="utilities">Utilities&lt;/h3>
&lt;p>The utilities available in the library, useful for composing the monad:&lt;/p>
&lt;ol>
&lt;li>&lt;code>flatten&lt;/code> - tranforms an array of &lt;code>DBAction&lt;/code>s into a &lt;code>DBAction&lt;/code> of an array of values,&lt;/li>
&lt;li>&lt;code>pure&lt;/code> - wraps a scalar / promise / function returning a promise with a &lt;code>DBAction&lt;/code> - useful to lift non-&lt;em>DBAction&lt;/em> into a &lt;em>DBAction&lt;/em>.&lt;/li>
&lt;li>&lt;code>chain&lt;/code> - builds a sequential chain of &lt;em>DBActions&lt;/em> - result of a previous is an argument for the latter,&lt;/li>
&lt;li>&lt;code>sequence&lt;/code> - runs operations concurrently; returns a single &lt;code>DBAction&lt;/code>,&lt;/li>
&lt;li>&lt;code>query&lt;/code> - creates a &lt;em>DBAction&lt;/em> for a query string.&lt;/li>
&lt;/ol>
&lt;h2 id="links">Links&lt;/h2>
&lt;ol>
&lt;li>&lt;a href="https://github.com/albsadowski/dbaction">&lt;em>DBAction&lt;/em> GitHub Repository&lt;/a>.&lt;/li>
&lt;li>&lt;a href="https://hackage.haskell.org/package/mtl-2.3.1/docs/Control-Monad-Reader.html">&lt;em>Reader Monad&lt;/em>&lt;/a>.&lt;/li>
&lt;li>Heavily inspired by &lt;a href="https://tpolecat.github.io/doobie/">&lt;em>doobie&lt;/em>&lt;/a>.&lt;/li>
&lt;/ol></description></item><item><title>Simple NLP Search</title><link>https://albsadowski.github.io/simple-nlp-search/</link><pubDate>Thu, 05 May 2016 23:29:33 +0000</pubDate><guid>https://albsadowski.github.io/simple-nlp-search/</guid><description>&lt;p>Full text search is easy to use. But the inherent ambiguity of natural languages
causes search results to be biased with false positives. To obtain more accurate results, we need to change the approach and provide more domain specific data to the search engine.&lt;/p>
&lt;p>The most common and easiest to improve search results is to introduce filters, i.e. multiple input fields (text fields, radio buttons etc.) named after properties. This way we know how to shape the query and then return specific results. In combination with some approximate string matching algorithms, we may obtain very accurate search results. Unfortunately filters require forms with multiple fields at the cost of simple UX. (see &lt;em>Figure 1&lt;/em>).&lt;/p>
&lt;p>&lt;img src="./ebay-motors.png" alt="Figure 1">&lt;/p>
&lt;p>What if we&amp;rsquo;d like to stick to a single text field and still have accurate search results (see &lt;em>Figure 2&lt;/em>)? Surely one needs to employ natural language processing (NLP) tools. But everyone in the IT industry knows that NLP is hard to master and majority thinks it&amp;rsquo;s a highly academic approach. How can this be easily employed to improve search results over a specific domain?&lt;/p>
&lt;p>&lt;img src="./featured-image.png" alt="Figure 2">&lt;/p>
&lt;h2 id="domain">Domain&lt;/h2>
&lt;p>Specificity of the domain is the key part of the approach. Machine learning algorithms are far from being ready to answer general questions. Even though the algorithms exist, they are far from our reach. For simplicity, we have to narrow the domain. Usually when we are in a need for introducing a search form, we operate within some area, i.e. finding a car at ebay.com we specify the type of the car, year of production, manufacturer, model etc..&lt;/p>
&lt;p>For the sake of this article, let&amp;rsquo;s take the domain of film screenings, i.e. tuple of: movie, theater and the date and time. We may also assume we know the geographical location of the theater and genre of the movie. We are going to query the film screening by title (or just genre), theater name (or just location) and date and time that the screening is going to happen - that is the data we need to collect from the user. Sample expressions we&amp;rsquo;d like to handle:&lt;/p>
&lt;ul>
&lt;li>&lt;em>the martian in san francisco tomorrow&lt;/em> - query all theaters in San Francisco that will play &lt;em>The Martian&lt;/em> tomorrow,&lt;/li>
&lt;li>&lt;em>the revenant in amc next week&lt;/em> - query &lt;em>AMC&lt;/em> theater for all shows of &lt;em>The Revenant&lt;/em> that will occur next week,&lt;/li>
&lt;li>&lt;em>cinemark next wednesday&lt;/em> - query &lt;em>Cinemark&lt;/em> theaters for all the shows that will occur next Wednesday,&lt;/li>
&lt;li>&lt;em>drama in san francisco on 11 June&lt;/em> - query all theaters in San Francisco for a drama that will occur on 11th of June.&lt;/li>
&lt;/ul>
&lt;p>All expressions are transformed from natural language to a query of the form:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-scala" data-lang="scala">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">case&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Query&lt;/span>&lt;span style="color:#f92672">(&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> movie&lt;span style="color:#66d9ef">:&lt;/span> &lt;span style="color:#66d9ef">Option&lt;/span>&lt;span style="color:#f92672">[&lt;/span>&lt;span style="color:#66d9ef">Either&lt;/span>&lt;span style="color:#f92672">[&lt;/span>&lt;span style="color:#66d9ef">MovieName&lt;/span>, &lt;span style="color:#66d9ef">MovieGenre&lt;/span>&lt;span style="color:#f92672">]],&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> theater&lt;span style="color:#66d9ef">:&lt;/span> &lt;span style="color:#66d9ef">Option&lt;/span>&lt;span style="color:#f92672">[&lt;/span>&lt;span style="color:#66d9ef">Either&lt;/span>&lt;span style="color:#f92672">[&lt;/span>&lt;span style="color:#66d9ef">TheaterName&lt;/span>, &lt;span style="color:#66d9ef">TheaterLocation&lt;/span>&lt;span style="color:#f92672">]]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> from&lt;span style="color:#66d9ef">:&lt;/span> &lt;span style="color:#66d9ef">Option&lt;/span>&lt;span style="color:#f92672">[&lt;/span>&lt;span style="color:#66d9ef">DateTime&lt;/span>&lt;span style="color:#f92672">],&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> to&lt;span style="color:#66d9ef">:&lt;/span> &lt;span style="color:#66d9ef">Option&lt;/span>&lt;span style="color:#f92672">[&lt;/span>&lt;span style="color:#66d9ef">DateTime&lt;/span>&lt;span style="color:#f92672">])&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">case&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MovieName&lt;/span>&lt;span style="color:#f92672">(&lt;/span>value&lt;span style="color:#66d9ef">:&lt;/span> &lt;span style="color:#66d9ef">String&lt;/span>&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">case&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">MovieGenre&lt;/span>&lt;span style="color:#f92672">(&lt;/span>value&lt;span style="color:#66d9ef">:&lt;/span> &lt;span style="color:#66d9ef">String&lt;/span>&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">case&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">TheaterName&lt;/span>&lt;span style="color:#f92672">(&lt;/span>value&lt;span style="color:#66d9ef">:&lt;/span> &lt;span style="color:#66d9ef">String&lt;/span>&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">case&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">TheaterLocation&lt;/span>&lt;span style="color:#f92672">(&lt;/span>value&lt;span style="color:#66d9ef">:&lt;/span> &lt;span style="color:#66d9ef">String&lt;/span>&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="need-for-nlp">Need for NLP&lt;/h2>
&lt;p>It is hard to extract information from natural language. If we assume that there are just a few kinds of input statements, like &lt;code>[MOVIE_NAME] in [THEATER_LOCATION] [TIME_EXPRESSION]&lt;/code>, then it might be possible to program the parser for such statements explicitly. But even though someone manages to do this, such an algorithm would be unmaintainable. With NLP tools we may approach this problem without the need to program explicitly.&lt;/p>
&lt;p>Moreover, some statements are extremely similar in their structure, e.g.: &lt;code>[MOVIE_NAME] [TIME_EXPRESSION]&lt;/code> and &lt;code>[THEATER_NAME] [TIME_EXPRESSION]&lt;/code> - it is impossible to unambiguously differentiate both statements. NLP tools also care about the structure of &lt;code>[MOVIE_NAME]&lt;/code> and &lt;code>[THEATER NAME]&lt;/code>, then when extracting the information from statements it has more data to make a decision than the explicit parser.&lt;/p>
&lt;h2 id="description-of-the-solution">Description of the solution&lt;/h2>
&lt;p>For our example the only subtask of information extraction we need is called &lt;em>named entity recognition&lt;/em>. Having the statement properly tagged we are able to compose our &lt;code>Query&lt;/code>. By tagging we mean assigning some domain specific meta information to each word from the statement, e.g.:&lt;/p>
&lt;ul>
&lt;li>&lt;em>the martian in san francisco tomorrow&lt;/em> -&amp;gt; &lt;em>(MOVIE_NAME: the martian) (PREPOSITION: in) (THEATER_LOCATION: san francisco) (TIME_EXPRESSION: tomorrow)&lt;/em>&lt;/li>
&lt;li>&lt;em>amc next wednesday&lt;/em> -&amp;gt; &lt;em>(THEATER_NAME: amc) (TIME_EXPRESSION: next wednesday)&lt;/em>&lt;/li>
&lt;/ul>
&lt;h3 id="tools">Tools&lt;/h3>
&lt;p>When trying to tackle the problem, our first attempt was to try the &lt;a href="http://nlp.stanford.edu/software/CRF-NER.shtml">Stanford Named Entity Recognizer&lt;/a>, which gave us stunning results, but unfortunately cannot be used commercially because of the GNU GPLv2 licensing.&lt;/p>
&lt;p>Finally we decided to use the &lt;a href="https://github.com/dlwh/epic">Epic&lt;/a> library from &lt;a href="http://www.scalanlp.org/">ScalaNLP&lt;/a> suite (all licensed under Apache 2.0). &lt;em>Epic&lt;/em> has many NLP algorithms implemented, but the downside we encountered is lack of the documentation thus it&amp;rsquo;s usage is far from straightforward.&lt;/p>
&lt;h3 id="sample-data">Sample data&lt;/h3>
&lt;p>In order to train the Named Entity Recognizer (NER) we need to supply the algorithm with sample data. If we don&amp;rsquo;t have any real life data then we may generate some random statements based on possible schemas, like:&lt;/p>
&lt;ul>
&lt;li>&lt;code>[MOVIE_NAME] in [THEATER_LOCATION] [TIME_EXPRESSION]&lt;/code>&lt;/li>
&lt;li>&lt;code>[MOVIE_GENRE] [TIME_EXPRESSION] in [THEATER_LOCATION]&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>The format of the input depends on the library we use. The academic standard for describing the training data, &lt;a href="http://www.cnts.ua.ac.be/conll2003/ner/">CoNLL&lt;/a>, covers much more than we need. Fortunately there is a way to simplify to just tagging, i.e.:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-txt" data-lang="txt">&lt;span style="display:flex;">&lt;span>the MOVIE_NAME
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>martian MOVIE_NAME
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>in PREPOSITION
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>san THEATER_LOCATION
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>francisco THEATER_LOCATION
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>tomorrow TIME_EXPRESSION
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>comedy MOVIE_GENRE
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>thursday TIME_EXPRESSION
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>evening TIME_EXPRESSION
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>in PREPOSITION
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>san THEATER_LOCATION
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>francisco THEATER_LOCATION
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The optimal size of the training sample depends on the complexity of the domain and should be verified empirically.&lt;/p>
&lt;p>You can check the example at &lt;a href="https://github.com/evojam/simple-nlp-search-dataset-generator">GitHub&lt;/a> how we generated sample data.&lt;/p>
&lt;h3 id="training-ner">Training NER&lt;/h3>
&lt;p>We need to encode the relationships between the tagged statements and then construct some consistent interpretations for further reuse. Statistical tools that solves this problem are called &lt;em>conditional random fields (CRFs)&lt;/em>. In &lt;em>ScalaNLP&lt;/em> there are two implementations of CRF available. The first one &lt;code>epic.sequences.CRF&lt;/code> is the ordinary linear-chain CRF and the second one &lt;code>epic.sequences.SemiCRF&lt;/code> is an implementation of semi-Markov linear chain that should have better performance at small cost of accuracy.&lt;/p>
&lt;h4 id="load-input-data-into-sequence-reader">Load input data into sequence reader&lt;/h4>
&lt;p>&lt;em>ScalaNLP&lt;/em> has built-in parser for CoNLL data - &lt;code>epic.corpora.CONLLSequenceReader&lt;/code> which accepts the data input we proposed in section &lt;em>Sample data&lt;/em>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-scala" data-lang="scala">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">var&lt;/span> sequenceReader &lt;span style="color:#66d9ef">=&lt;/span> &lt;span style="color:#a6e22e">CONLLSequenceReader&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">.&lt;/span>readTrain&lt;span style="color:#f92672">(&lt;/span>dataSetInputStream&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">.&lt;/span>toIndexedSeq
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="apply-segmentation-function">Apply segmentation function&lt;/h4>
&lt;p>We train the CRF by transforming the input data to &lt;code>epic.sequences.Segmentation[Any, String]&lt;/code>. The segmentation is grouping the same tags in a row.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-scala" data-lang="scala">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">val&lt;/span> seq &lt;span style="color:#66d9ef">=&lt;/span> sequenceReader&lt;span style="color:#f92672">.&lt;/span>map&lt;span style="color:#f92672">(&lt;/span>segmentation&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>the segmentation function we use:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-scala" data-lang="scala">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">def&lt;/span> segmentation&lt;span style="color:#f92672">(&lt;/span>ex&lt;span style="color:#66d9ef">:&lt;/span> &lt;span style="color:#66d9ef">Example&lt;/span>&lt;span style="color:#f92672">[&lt;/span>&lt;span style="color:#66d9ef">IndexedSeq&lt;/span>&lt;span style="color:#f92672">[&lt;/span>&lt;span style="color:#66d9ef">String&lt;/span>&lt;span style="color:#f92672">]&lt;/span>, &lt;span style="color:#66d9ef">IndexedSeq&lt;/span>&lt;span style="color:#f92672">[&lt;/span>&lt;span style="color:#66d9ef">IndexedSeq&lt;/span>&lt;span style="color:#f92672">[&lt;/span>&lt;span style="color:#66d9ef">String&lt;/span>&lt;span style="color:#f92672">]])&lt;/span>&lt;span style="color:#66d9ef">:&lt;/span> &lt;span style="color:#66d9ef">Segmentation&lt;/span>&lt;span style="color:#f92672">[&lt;/span>&lt;span style="color:#66d9ef">Any&lt;/span>, &lt;span style="color:#66d9ef">String&lt;/span>&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#66d9ef">=&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> segments &lt;span style="color:#66d9ef">=&lt;/span> ex&lt;span style="color:#f92672">.&lt;/span>label&lt;span style="color:#f92672">.&lt;/span>foldLeft&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#a6e22e">List&lt;/span>&lt;span style="color:#f92672">.&lt;/span>empty&lt;span style="color:#f92672">[(&lt;/span>&lt;span style="color:#66d9ef">String&lt;/span>, &lt;span style="color:#66d9ef">Int&lt;/span>, &lt;span style="color:#66d9ef">Int&lt;/span>&lt;span style="color:#f92672">)]&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> &lt;span style="color:#f92672">(&lt;/span>acc&lt;span style="color:#f92672">,&lt;/span> label&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">=&amp;gt;&lt;/span> acc &lt;span style="color:#66d9ef">match&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> head &lt;span style="color:#66d9ef">:&lt;/span>&lt;span style="color:#66d9ef">:&lt;/span> &lt;span style="color:#66d9ef">tail&lt;/span> &lt;span style="color:#f92672">=&amp;gt;&lt;/span> head &lt;span style="color:#66d9ef">match&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> &lt;span style="color:#f92672">(&lt;/span>`label`&lt;span style="color:#f92672">,&lt;/span> beg&lt;span style="color:#f92672">,&lt;/span> end&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">=&amp;gt;&lt;/span> &lt;span style="color:#f92672">(&lt;/span>label&lt;span style="color:#f92672">,&lt;/span> beg&lt;span style="color:#f92672">,&lt;/span> end &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">:&lt;/span>&lt;span style="color:#66d9ef">:&lt;/span> &lt;span style="color:#66d9ef">tail&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> &lt;span style="color:#f92672">(&lt;/span>nextLabel&lt;span style="color:#f92672">,&lt;/span> beg&lt;span style="color:#f92672">,&lt;/span> end&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">=&amp;gt;&lt;/span> &lt;span style="color:#f92672">(&lt;/span>label&lt;span style="color:#f92672">,&lt;/span> end&lt;span style="color:#f92672">,&lt;/span> end &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">:&lt;/span>&lt;span style="color:#66d9ef">:&lt;/span> &lt;span style="color:#66d9ef">head&lt;/span> &lt;span style="color:#66d9ef">::&lt;/span> &lt;span style="color:#66d9ef">tail&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> &lt;span style="color:#a6e22e">Nil&lt;/span> &lt;span style="color:#66d9ef">=&amp;gt;&lt;/span> &lt;span style="color:#a6e22e">List&lt;/span>&lt;span style="color:#f92672">((&lt;/span>&lt;span style="color:#a6e22e">String&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#f92672">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">val&lt;/span> segmentsSeq &lt;span style="color:#66d9ef">=&lt;/span> segments
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">.&lt;/span>reverse&lt;span style="color:#f92672">.&lt;/span>map &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> &lt;span style="color:#f92672">(&lt;/span>label&lt;span style="color:#f92672">,&lt;/span> beg&lt;span style="color:#f92672">,&lt;/span> end&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">=&amp;gt;&lt;/span> &lt;span style="color:#f92672">(&lt;/span>label&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#a6e22e">Span&lt;/span>&lt;span style="color:#f92672">(&lt;/span>beg&lt;span style="color:#f92672">,&lt;/span> end&lt;span style="color:#f92672">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">.&lt;/span>toIndexedSeq
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">Segmentation&lt;/span>&lt;span style="color:#f92672">(&lt;/span>segmentsSeq&lt;span style="color:#f92672">,&lt;/span> ex&lt;span style="color:#f92672">.&lt;/span>features&lt;span style="color:#f92672">.&lt;/span>map&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">_&lt;/span>&lt;span style="color:#f92672">.&lt;/span>mkString&lt;span style="color:#f92672">),&lt;/span> ex&lt;span style="color:#f92672">.&lt;/span>id&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="build-crf">Build CRF&lt;/h4>
&lt;p>having the input segmented, we can build the CRF:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-scala" data-lang="scala">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">val&lt;/span> crf &lt;span style="color:#66d9ef">=&lt;/span> &lt;span style="color:#a6e22e">SemiCRF&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">.&lt;/span>buildSimple&lt;span style="color:#f92672">(&lt;/span>seq&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">.&lt;/span>asInstanceOf&lt;span style="color:#f92672">[&lt;/span>&lt;span style="color:#66d9ef">SemiCRF&lt;/span>&lt;span style="color:#f92672">[&lt;/span>&lt;span style="color:#66d9ef">String&lt;/span>, &lt;span style="color:#66d9ef">String&lt;/span>&lt;span style="color:#f92672">]]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="use-the-trained-crf-for-tagging-sequences">Use the trained &lt;code>crf&lt;/code> for tagging sequences&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-scala" data-lang="scala">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">val&lt;/span> taggedSequence&lt;span style="color:#66d9ef">:&lt;/span> &lt;span style="color:#66d9ef">Segmentation&lt;/span>&lt;span style="color:#f92672">[&lt;/span>&lt;span style="color:#66d9ef">String&lt;/span>, &lt;span style="color:#66d9ef">String&lt;/span>&lt;span style="color:#f92672">]&lt;/span> &lt;span style="color:#66d9ef">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>crf&lt;span style="color:#f92672">.&lt;/span>bestSequence&lt;span style="color:#f92672">(&lt;/span>epic&lt;span style="color:#f92672">.&lt;/span>preprocess&lt;span style="color:#f92672">.&lt;/span>tokenize&lt;span style="color:#f92672">(&lt;/span>inputString&lt;span style="color:#f92672">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>epic.preprocess.tokenize&lt;/code> is just tokenizing by whitespace.&lt;/p>
&lt;p>The &lt;code>Segmentation&lt;/code> carries the tagged sequence. When we render a sample expression we get a string with tagged segments:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-txt" data-lang="txt">&lt;span style="display:flex;">&lt;span>[MOVIE_NAME: the martian] [PREPOSITION: in] [THEATER_LOCATION: san francisco] [PREPOSITION: on] [TIME_EXPRESSION: 11th June 2016]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>With such a tagging we are almost ready to construct the &lt;code>Query&lt;/code>. The only missing part are the &lt;code>TIME_EXPRESSION&lt;/code>s. We need explicit &lt;code>from&lt;/code> and &lt;code>to&lt;/code> parameters of type &lt;code>DateTime&lt;/code>. We may use &lt;a href="http://www.ocpsoft.org/prettytime/nlp/">PrettyTime::NLP&lt;/a> to parse explicit time expressions, like: &lt;code>11th June 2016&lt;/code>, but if we want to obtain something more sophisticated, like &lt;code>next Wed&lt;/code> or &lt;code>tomorrow&lt;/code> we should employ the NLP approach again, i.e. training the CRF for time expressions.&lt;/p>
&lt;p>The results are pretty astonishing. The &lt;code>crf&lt;/code>, once trained, is working instantly. The accuracy of the interpretation will vary depending on the complexity of the domain and size of the training sample. In our case, we were surprised about the accuracy - even for ambiguous statements, the &lt;code>crf&lt;/code> was doing well.&lt;/p>
&lt;p>For the sample size of 200K input statements (generated with &lt;a href="https://github.com/evojam/simple-nlp-search-dataset-generator">simple-ner-search-dataset-generator&lt;/a>, we&amp;rsquo;ve trained the NER with &lt;a href="https://github.com/evojam/ner-trainer">ner-trainer&lt;/a>, and get the following results:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-txt" data-lang="txt">&lt;span style="display:flex;">&lt;span>the martian in san francisco tomorrow
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[MOVIE_NAME: the martian] [PREPOSITION: in] [THEATER_LOCATION: san francisco] [TIME_EXPRESSION: tomorrow] (in 8 ms)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>the revenant in amc next week
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[MOVIE_NAME: the revenant] [PREPOSITION: in] [THEATER_NAME: amc] [TIME_EXPRESSION: next week] (in 15 ms)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>cinemark next wednesday
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[THEATER_NAME: cinemark] [TIME_EXPRESSION: next wednesday] (in 2 ms)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>drama in san francisco on 11 june
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[MOVIE_GENRE: drama] [PREPOSITION: in] [THEATER_LOCATION: san francisco] [PREPOSITION: on] [TIME_EXPRESSION: 11 june] (in 4 ms)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>amc next wednesday
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[THEATER_NAME: amc] [TIME_EXPRESSION: next wednesday] (in 2 ms)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>the martian in san francisco on 11th june 2016
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[MOVIE_NAME: the martian] [PREPOSITION: in] [THEATER_LOCATION: san francisco] [PREPOSITION: on] [TIME_EXPRESSION: 11th june 2016] (in 8 ms)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>You can check this yourself in the interactive session by installing the &lt;a href="https://github.com/evojam/ner-trainer">ner-trainer&lt;/a> and loading the serialized &lt;a href="https://www.dropbox.com/s/qfezeynlcegkfni/film-screenings.tar.gz?dl=0">example&lt;/a> by calling &lt;code>ner-trainer -l film-screenings.tar.gz&lt;/code>.&lt;/p>
&lt;h3 id="tradeoffs">Tradeoffs&lt;/h3>
&lt;p>Unfortunately training the &lt;em>CRF&lt;/em> is extremely time consuming (measured in hours). There is a need to serialize the &lt;code>SemiCRF&lt;/code> object in order not to waste time. The serialization comes at the cost of taking care of binary compatibility. Also &lt;code>SemiCRF&lt;/code> might be a quite heavy object, so there comes the cost of additional memory.&lt;/p>
&lt;p>The &lt;em>Epic&lt;/em> library is not easy to use. The documentation is not very helpful, and also lacks serious static typing. Even in this short example we were not able to avoid &lt;code>asInstanceOf&lt;/code>.&lt;/p>
&lt;h2 id="conclusions">Conclusions&lt;/h2>
&lt;p>The libraries that are currently available nicely cover the hard parts of the problem. The tradeoffs are possible to overcome and many of them are relatively easy to fix, so probably will disappear in the future. Nevertheless it is possible to construct quite sophisticated NLP based search without drowning in complicated math. Even the newcomer should be able to implement the search in a matter of days.&lt;/p>
&lt;h3 id="urls">URLs&lt;/h3>
&lt;ul>
&lt;li>ScalaNLP: &lt;a href="http://www.scalanlp.org/">http://www.scalanlp.org/&lt;/a>&lt;/li>
&lt;li>Stanford Named Entity Recognizer: &lt;a href="http://nlp.stanford.edu/software/CRF-NER.shtml">http://nlp.stanford.edu/software/CRF-NER.shtml&lt;/a>&lt;/li>
&lt;li>PrettyTime::NLP: &lt;a href="http://www.ocpsoft.org/prettytime/nlp/">http://www.ocpsoft.org/prettytime/nlp/&lt;/a>&lt;/li>
&lt;li>NER Trainer: &lt;a href="https://github.com/evojam/ner-trainer">https://github.com/evojam/ner-trainer&lt;/a>&lt;/li>
&lt;li>Film Screenings Data Set Generator: &lt;a href="https://github.com/evojam/simple-nlp-search-dataset-generator">https://github.com/evojam/simple-nlp-search-dataset-generator&lt;/a>&lt;/li>
&lt;li>Sample &lt;a href="https://drive.google.com/file/d/0ByjmxsRtyWkLMWwxT2cyamJ1WUU/view?usp=sharing">serialized CRF for film screenings&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>All of you feel invited to checkout and hack with NER trainer and data set generator on your domain. Please provide feedback in comments how this approach is working for you.&lt;/p>
&lt;p>This article was originally published on &lt;a href="http://tech.evojam.com">tech.evojam.com&lt;/a> – there are many other interesting posts there!&lt;/p></description></item></channel></rss>